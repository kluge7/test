name: Source Build

on:
  workflow_dispatch:
  push:
  schedule:
    # Run every day to detect flakiness and broken dependencies
    - cron: '03 3 * * *'

jobs:
  source_build:
    name: Ubuntu 22.04 Build
    runs-on: ubuntu-22.04

    steps:
      - name: Setup ROS2 Humble Environment
        uses: ros-tooling/setup-ros@0.7.9
        with:
          use-ros2-testing: true
          required-ros-distributions: humble

      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          sudo apt update
          sudo apt install -y python3-colcon-common-extensions
          vcs import < src/${{ github.repository }}/ros2.repos

      - name: Build ROS2 Workspace
        run: |
          colcon build --event-handlers console_cohesion+

      - name: Run Tests
        run: |
          colcon test --event-handlers console_cohesion+
          colcon test-result --verbose

      - name: Upload Build Logs
        uses: actions/upload-artifact@v4
        with:
          name: colcon-logs-humble-ubuntu-22.04
          path: ros_ws/log
