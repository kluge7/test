name: Clang-Tidy

on: push

jobs:
  build-and-lint:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up ROS 2 and dependencies
        run: |
          sudo apt update
          sudo apt install -y colcon-common-extensions clang-tidy
          sudo apt install -y python3-vcstool  # If you need it for vcs import

      - name: Install additional dependencies
        run: |
          # If your workspace has dependencies, resolve them
          vcs import < src/<dependency-file>.repos
          rosdep install --from-paths src --ignore-src -r -y

      - name: Build the project with colcon
        run: |
          cd $GITHUB_WORKSPACE
          colcon build --cmake-args -DCMAKE_EXPORT_COMPILE_COMMANDS=ON

      - name: Run Clang-Tidy
        run: |
          src/vortex-auv/scripts/run_clang_tidy.sh

      - name: Check Clang-Tidy Results
        if: failure()
        run: |
          echo "Clang-Tidy has identified issues that need to be resolved. Please review the output."
          exit 1

      - name: Save Clang-Tidy Results
        if: failure()
        run: |
          mkdir -p clang-tidy-results
          src/vortex-auv/scripts/run_clang_tidy.sh > clang-tidy-results/report.txt

      - name: Upload Clang-Tidy Results
        if: failure()
        uses: actions/upload-artifact@v2
        with:
          name: clang-tidy-results
          path: clang-tidy-results

      - name: Final status
        if: success()
        run: echo "Pipeline completed successfully!"
